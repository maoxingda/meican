## 1. redshift（s3） to es 

- datax

- logstash
- kettle
- glue

## 2. es交互方案查询数据dsl

### 2.1 index alias & template

```json
PUT _template/app-name
{
  "index_patterns": [
    "app1-name*",
    "app2-name*"
  ],
  "aliases": {
    "last_three_month": {}
  },
  "mappings": {
    "properties": {
      "targeted_date": {
        "type": "date",
        "format": "yyyy-MM-dd"
      },
      "targeted_timestamp": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss"
      },
      "transaction_id": {
        "type": "long",
        "index": false
      },
      "transaction_type": {
        "type": "keyword"
      },
      "restaurant_name": {
        "type": "keyword"
      },
      "meal_plan_name": {
        "type": "keyword"
      },
      "user_name": {
        "type": "wildcard"
      },
      "department_name": {
        "type": "keyword"
      },
      "cost_center_name": {
        "type": "keyword"
      },
      "employee_number": {
        "type": "wildcard"
      },
      "email": {
        "type": "wildcard"
      },
      "canbu": {
        "type": "long"
      },
      "personal_balance": {
        "type": "long"
      },
      "third_party_balance": {
        "type": "long"
      },
      "total_paid": {
        "type": "long"
      }
    }
  }
}
```

### 2.2 创建最近一个月份index

```json
PUT <app1-name-{now-1M%2FM{yyyy.MM}}>
```

### 2.3 删除3个月之前alias

```json
POST _aliases
{
  "actions": [
    {
      "remove": {
        "index": "<app1-name-{now%2FM-3M{yyyy.MM}}>", # 目前只在url路径中支持日期数学表达式
        "alias": "last_three_month"
      }
    }
  ]
}
```

### 2.4 获取表头【可选项】数目小于等于size

```json
GET last_three_month/_search
{
  "query": {
    "match_all": {}
  },
  "collapse": {
    "field": "transaction_type"
  },
  "_source": "",
  "size": 20
} # 分页获取是否需要排序
```

### 2.5 获取满足特定条件的doc数目，用于分页

```json
GET app1-name/_count
{
  "query": {
    "range": {
      "targeted_date": {
        "gte": "2021-03-01",
        "lte": "2021-03-28",
        "format": "yyyy-MM-dd"
      }
    }
  }
}
```

### 2.6 日期范围筛选，分页，排序

```json
GET last_three_month/_search
{
  "query": {
    "range": {
      "targeted_date": {
        "gte": "2021-03-01",
        "lte": "2021-03-28",
        "format": "yyyy-MM-dd"
      }
    }
  },
  "from": 0,
  "size": 5,
  "_source": [
    "targeted_date"
  ],
  "sort": [
    {
      "targeted_date": {
        "order": "desc"
      }
    }
  ]
}
```

### 2.7 表头【多选】筛选

```json
GET last_three_month/_search
{
  "query": {
    "terms": {
      "transaction_type": [
        "pay",
        "refund"
      ]
    }
  }
}
```

### 2.8 多条件组合筛选

```json
GET last_three_month/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "range": {
            "targeted_date": {
              "gte": "2021-03-01",
              "lte": "2021-03-28",
              "format": "yyyy-MM-dd"
            }
          }
        },
        {
          "term": {
            "transaction_type": "pay"
          }
        },
        {
          "term": {
            "restaurant_name": "迅达电梯餐厅"
          }
        }
      ]
    }
  }
}
```

### 2.9 聚合

```json
GET last_three_month/_search
{
  "query": {
    "match_all": {}
  },
  "aggs": {
    "total_paid": {
      "sum": {
        "field": "total_paid"
      }
    }
  },
  "size": 0
}
```

### 2.10 通配符查询

```json
GET last_three_month/_search
{
  "query": {
    "wildcard": {
      "employee_number": "*19778*"
    }
  }
}
```



## 3. memo

### 3.1 es索引最小单位<font color=red>word</font>

### 3.2 <font color=red>前缀索引</font>和<font color=red>通配符索引</font>效率

### 3.3 了解<font color=red>ngram</font>

### 3.4 scroll vs from&size

### 3.5 读取某个时间点快照？

### 3.6 分页获取是否需要排序
