- [x] **历年来**：从什么时候开始？**<font color=red>2016</font>**

- [x] 逐月统计：结果是否只需要在下个月出上个月及以前的结果？**<font color=red>没问题</font>**

- [x] 某个客户当月是新增【大客户】，下个月变成【普通客户】，第1个月留存该客户算大客户还是小客户，还是什么都不算？<font color=red>变成小客户加到小客户，变成大客户加到大客户</font>

   | 当月新增用户  | 第1个月 | 第2个月                    | 第3个月                    | 第4个月 | 第5个月                    |
   | ------------- | ------- | -------------------------- | -------------------------- | ------- | -------------------------- |
   | 大客户a, b, c | abc     | ab<font color=red>d</font> | ab<font color=red>c</font> | ab      | ab<font color=red>c</font> |
   | 小客户d, e    | de      | <font color=red>c</font>e  | de                         | de      | de                         |

- [x] 需要从客户上线以来的所有历史数据？<font color=red>是</font>

- [x] <font color=red>需要补数据</font>

- [x] 筛选条件中的【城市】是干嘛用的？客户下线是所有城市，所有餐别都没有订单？<font color=red>去掉第一、二张表中的【城市】</font>

- [x] 上线日期取用餐时间而不是订单产生时间（online_date：target_date）

- [x] gmv用<font color=blue>user_orders.total_paid</font>求和？<font color=red>是</font>

```sql
create table ads.client_retention_per_month
(
  online_date     varchar(7),       --  上线日期（yyyy-MM）
  nth_month       bigint,           --  第几月留存
  online_cnt      bigint,           --  上线客户数
  retention_cnt   bigint,           --  留存客户数
  retention_ratio decimal(4, 2),    --  留存率
  client_type     varchar(30),      --  客户类型（大客户 | 普通客户）
  gmv_owner       varchar(30)       --  销售额归属
);
```

```sql
create table ads.client_offline_history
(
  client_id 				bigint,		
  client_id_rn 			varchar(100),
  client_name 			varchar(765),	 -- 客户名称
  online_date 			date,					 -- 上线日期（yyyy-MM-dd）
  offline_date 			date,					 -- 下线日期（yyyy-MM-dd）
  history_total_gmv bigint,				 -- 历史gmv
  month_avg_gmv 		decimal(4, 2), -- 月平均gmv（历史gmv/在线月数）
  client_members 		bigint,				 -- 客户成员数
  meal_plans 				bigint, 			 -- 用餐计划（餐别）数
  gmv_owner 				varchar(765)	 -- 销售额归属
);
```

```sql
create table ads.meal_plan_offline_history
(
  meal_plan_id       bigint,
  meal_plan_id_rn    varchar(100),
  meal_plan_name     varchar(765),   	-- 餐别名称
  online_date        date,      			-- 上线日期（yyyy-MM-dd）
  offline_date       date,      			-- 下线日期（yyyy-MM-dd）
  client_id          bigint,
  client_id_rn       varchar(100),
  client_name        varchar(765),   	-- 客户名称
  city               varchar(765),   	-- 用餐计划（餐别））城市
  history_total_gmv  bigint,    			-- 历史gmv
  month_avg_gmv      decimal(4, 2),   -- 月平均gmv（历史gmv/在线月数）
  client_members     bigint,   				-- 客户成员数
  gmv_owner          varchar(765)   	-- 销售额归属
);
```

#### 实现涉及的表

##### 维度表

- [x] cities
- [x] meal_plans
- [ ] clients（需要新建，数据来自于ods层，【只需客户名称】）
- [x] client_members

##### 事实表

- [x] user_orders
- [x] user_transaction_meal_plan_details（<font color=red>用餐计划gmv：amount字段求和</font>）

#### 名词解释

- meal_plan(corp_name)：美餐（产品）午餐 | 美餐（产品）晚餐 | 美餐（产品）到店午餐

#### 客户分类

1. 只在某个月有订单（尾单与当前月份差值大于1即为<font color=red>下线客户</font>）
2. 某两个月或者两个月以上有订单（相邻两单日期月份差值大于1即为<font color=red>下线客户</font>）

#### 问题

- [x] 客户成员数
- [x] 用餐计划（餐别）数
- [x] 销售额归属
- [ ] 客户名称取【用餐计划】中的client_name

